<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Obsidian Webhooks</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
    <div class="min-h-screen">
        <nav class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <h1 class="text-xl font-semibold">Obsidian Webhooks</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-600">{{.UserID}}</span>
                        <a href="/logout" class="text-sm text-red-600 hover:text-red-800">Logout</a>
                    </div>
                </div>
            </div>
        </nav>
        
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
<div class="space-y-6">
    <!-- API Keys Section -->
    <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-lg font-semibold mb-4">Your API Keys</h2>
        
        {{if .WebhookKey}}
        <div class="space-y-6">
            <!-- Webhook Key (Write-Only) -->
            <div class="border-l-4 border-red-400 pl-4">
                <h3 class="text-md font-medium text-gray-900 mb-2">ðŸš¨ Webhook URL (Write-Only)</h3>
                <p class="text-sm text-gray-600 mb-3">Share this with IFTTT, Zapier, etc. Can only ADD notes, cannot read existing ones.</p>
                <div class="space-y-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Webhook URL</label>
                        <div class="flex">
                            <input type="text" readonly value="https://{{.WebhookURL}}?path=your/note.md" 
                                class="flex-1 px-3 py-2 bg-gray-50 border border-gray-300 rounded-l-md text-sm font-mono">
                            <button onclick="navigator.clipboard.writeText(this.previousElementSibling.value)" 
                                class="px-3 py-2 bg-gray-100 border border-l-0 border-gray-300 rounded-r-md hover:bg-gray-200">
                                ðŸ“‹
                            </button>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <form method="POST" action="/rotate-webhook-key" class="inline">
                            <button type="submit" 
                                class="px-3 py-2 bg-red-600 text-white text-sm rounded-md hover:bg-red-700">
                                ðŸ”„ Rotate Webhook URL
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Client Key (Read-Only) -->
            <div class="border-l-4 border-green-400 pl-4">
                <h3 class="text-md font-medium text-gray-900 mb-2">ðŸ”’ Client Key (Read-Only)</h3>
                <p class="text-sm text-gray-600 mb-3">Use this in your Obsidian plugin. Can only READ events, cannot write.</p>
                <div class="space-y-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Client Key</label>
                        <div class="flex">
                            <input type="text" readonly value="{{.ClientKey}}" 
                                class="flex-1 px-3 py-2 bg-gray-50 border border-gray-300 rounded-l-md text-sm font-mono">
                            <button onclick="navigator.clipboard.writeText(this.previousElementSibling.value)" 
                                class="px-3 py-2 bg-gray-100 border border-l-0 border-gray-300 rounded-r-md hover:bg-gray-200">
                                ðŸ“‹
                            </button>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <form method="POST" action="/rotate-client-key" class="inline">
                            <button type="submit" 
                                class="px-3 py-2 bg-green-600 text-white text-sm rounded-md hover:bg-green-700">
                                ðŸ”„ Rotate Client Key
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {{else}}
        <form method="POST" action="/generate-token">
            <button type="submit" 
                class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Generate API Keys
            </button>
        </form>
        {{end}}
    </div>

    <!-- Usage Example -->
    <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-lg font-semibold mb-4">Usage Example</h2>
        <pre class="bg-gray-900 text-gray-100 p-4 rounded-md overflow-x-auto text-sm">
<code>curl -X POST "https://{{.WebhookURL}}?path=daily/$(date +%Y-%m-%d).md" \
  -H "Content-Type: text/plain" \
  -d "## $(date +%H:%M)
- Your note content here"</code>
        </pre>
    </div>

    <!-- Recent Events -->
    <div class="bg-white shadow rounded-lg p-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold">Recent Events</h2>
            {{if .Events}}
            <button onclick="openBulkEditModal()"
                class="px-3 py-1 text-sm bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                Bulk Edit Paths
            </button>
            {{end}}
        </div>
        {{if .Events}}
        <div class="space-y-3" id="events-container">
            {{range .Events}}
            <div class="border border-gray-200 rounded-md p-3" data-event-id="{{.ID}}">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-sm font-medium text-gray-900">{{.Path}}</span>
                    <div class="flex items-center space-x-2">
                        <span class="text-xs text-gray-500">{{.Timestamp.Format "2006-01-02 15:04:05"}}</span>
                        <button onclick="deleteEvent('{{.ID}}')"
                            class="text-red-600 hover:text-red-800 text-xs px-2 py-1 rounded border border-red-300 hover:bg-red-50"
                            title="Delete event">
                            Delete
                        </button>
                    </div>
                </div>
                <pre class="text-xs bg-gray-50 p-2 rounded overflow-x-auto">{{.Data}}</pre>
            </div>
            {{end}}
        </div>
        {{else}}
        <p class="text-gray-500">No events yet</p>
        {{end}}
    </div>
</div>
        </main>
    </div>

    <script>
    async function deleteEvent(eventId) {
        if (!confirm('Are you sure you want to delete this event? This cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/events/${eventId}`, {
                method: 'DELETE',
                credentials: 'same-origin'
            });

            if (response.ok) {
                // Remove the event element from the DOM
                const eventElement = document.querySelector(`[data-event-id="${eventId}"]`);
                if (eventElement) {
                    eventElement.style.opacity = '0';
                    eventElement.style.transition = 'opacity 0.3s';
                    setTimeout(() => {
                        eventElement.remove();

                        // Check if there are any events left
                        const container = document.getElementById('events-container');
                        if (container && container.children.length === 0) {
                            container.parentElement.innerHTML = '<p class="text-gray-500">No events yet</p>';
                        }
                    }, 300);
                }
            } else {
                const errorText = await response.text();
                alert(`Failed to delete event: ${errorText}`);
            }
        } catch (error) {
            alert(`Error deleting event: ${error.message}`);
        }
    }

    // Bulk edit paths functionality
    function openBulkEditModal() {
        document.getElementById('bulkEditModal').classList.remove('hidden');
        document.getElementById('preview-results').innerHTML = '';
        document.getElementById('apply-button').classList.add('hidden');
    }

    function closeBulkEditModal() {
        document.getElementById('bulkEditModal').classList.add('hidden');
        document.getElementById('oldPrefix').value = '';
        document.getElementById('newPrefix').value = '';
        document.getElementById('preview-results').innerHTML = '';
        document.getElementById('apply-button').classList.add('hidden');
    }

    async function previewBulkUpdate() {
        const oldPrefix = document.getElementById('oldPrefix').value;
        const newPrefix = document.getElementById('newPrefix').value;

        if (!oldPrefix || !newPrefix) {
            alert('Please enter both old and new path prefixes');
            return;
        }

        try {
            const response = await fetch('/bulk-update-paths', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    oldPrefix: oldPrefix,
                    newPrefix: newPrefix,
                    preview: true
                })
            });

            if (response.ok) {
                const data = await response.json();
                displayPreviewResults(data);
            } else {
                const errorText = await response.text();
                alert(`Failed to preview: ${errorText}`);
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }

    function displayPreviewResults(data) {
        const resultsDiv = document.getElementById('preview-results');

        if (data.matchedEvents === 0) {
            resultsDiv.innerHTML = `
                <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4">
                    <p class="text-yellow-800">No events found matching the old prefix "${data.updates ? '' : document.getElementById('oldPrefix').value}"</p>
                    <p class="text-sm text-yellow-600 mt-1">Total events scanned: ${data.totalEvents}</p>
                </div>
            `;
            document.getElementById('apply-button').classList.add('hidden');
            return;
        }

        let html = `
            <div class="bg-blue-50 border border-blue-200 rounded-md p-4 mb-4">
                <p class="text-blue-900 font-medium">Found ${data.matchedEvents} event(s) to update</p>
                <p class="text-sm text-blue-700">Total events scanned: ${data.totalEvents}</p>
            </div>
            <div class="max-h-64 overflow-y-auto space-y-2">
        `;

        const maxShow = 20;
        const updates = data.updates.slice(0, maxShow);

        updates.forEach(update => {
            html += `
                <div class="bg-gray-50 border border-gray-200 rounded p-2 text-sm">
                    <div class="font-mono text-red-600">${escapeHtml(update.oldPath)}</div>
                    <div class="text-gray-500 text-xs">â†’</div>
                    <div class="font-mono text-green-600">${escapeHtml(update.newPath)}</div>
                </div>
            `;
        });

        if (data.matchedEvents > maxShow) {
            html += `<p class="text-sm text-gray-500 text-center py-2">... and ${data.matchedEvents - maxShow} more</p>`;
        }

        html += '</div>';
        resultsDiv.innerHTML = html;
        document.getElementById('apply-button').classList.remove('hidden');
    }

    async function applyBulkUpdate() {
        const oldPrefix = document.getElementById('oldPrefix').value;
        const newPrefix = document.getElementById('newPrefix').value;

        if (!confirm(`Are you sure you want to update all matching event paths?\n\nOld prefix: "${oldPrefix}"\nNew prefix: "${newPrefix}"\n\nThis cannot be undone.`)) {
            return;
        }

        try {
            const response = await fetch('/bulk-update-paths', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    oldPrefix: oldPrefix,
                    newPrefix: newPrefix,
                    preview: false
                })
            });

            if (response.ok) {
                const data = await response.json();
                alert(`Successfully updated ${data.updatedCount} event(s)!`);
                closeBulkEditModal();
                // Reload the page to show updated events
                window.location.reload();
            } else {
                const errorText = await response.text();
                alert(`Failed to apply updates: ${errorText}`);
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    </script>

    <!-- Bulk Edit Modal -->
    <div id="bulkEditModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Bulk Edit Event Paths</h3>
                <button onclick="closeBulkEditModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>

            <div class="space-y-4">
                <p class="text-sm text-gray-600">Update all event paths that start with a specific prefix. This is useful for reorganizing your notes.</p>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Old Path Prefix</label>
                    <input type="text" id="oldPrefix" placeholder="e.g., 0 - Inbox/"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <p class="text-xs text-gray-500 mt-1">All events with paths starting with this will be updated</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">New Path Prefix</label>
                    <input type="text" id="newPrefix" placeholder="e.g., 0-Inbox/"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <p class="text-xs text-gray-500 mt-1">The old prefix will be replaced with this</p>
                </div>

                <div class="flex space-x-2">
                    <button onclick="previewBulkUpdate()"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                        Preview Changes
                    </button>
                    <button onclick="closeBulkEditModal()"
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">
                        Cancel
                    </button>
                </div>

                <div id="preview-results" class="mt-4"></div>

                <button id="apply-button" onclick="applyBulkUpdate()"
                    class="hidden w-full mt-4 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                    Apply Changes
                </button>
            </div>
        </div>
    </div>
</body>
</html>