<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Obsidian Webhooks</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
    <div class="min-h-screen">
        <nav class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <h1 class="text-xl font-semibold">Obsidian Webhooks</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-600">{{.UserID}}</span>
                        <a href="/logout" class="text-sm text-red-600 hover:text-red-800">Logout</a>
                    </div>
                </div>
            </div>
        </nav>
        
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
<div class="space-y-6">
    <!-- API Keys Section -->
    <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-lg font-semibold mb-4">Your API Keys</h2>
        
        {{if .WebhookKey}}
        <div class="space-y-6">
            <!-- Webhook Key (Write-Only) -->
            <div class="border-l-4 border-red-400 pl-4">
                <h3 class="text-md font-medium text-gray-900 mb-2">ðŸš¨ Webhook URL (Write-Only)</h3>
                <p class="text-sm text-gray-600 mb-3">Share this with IFTTT, Zapier, etc. Can only ADD notes, cannot read existing ones.</p>
                <div class="space-y-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Webhook URL</label>
                        <div class="flex">
                            <input type="text" readonly value="https://{{.WebhookURL}}?path=your/note.md" 
                                class="flex-1 px-3 py-2 bg-gray-50 border border-gray-300 rounded-l-md text-sm font-mono">
                            <button onclick="navigator.clipboard.writeText(this.previousElementSibling.value)" 
                                class="px-3 py-2 bg-gray-100 border border-l-0 border-gray-300 rounded-r-md hover:bg-gray-200">
                                ðŸ“‹
                            </button>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <form method="POST" action="/rotate-webhook-key" class="inline">
                            <button type="submit" 
                                class="px-3 py-2 bg-red-600 text-white text-sm rounded-md hover:bg-red-700">
                                ðŸ”„ Rotate Webhook URL
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Client Key (Read-Only) -->
            <div class="border-l-4 border-green-400 pl-4">
                <h3 class="text-md font-medium text-gray-900 mb-2">ðŸ”’ Client Key (Read-Only)</h3>
                <p class="text-sm text-gray-600 mb-3">Use this in your Obsidian plugin. Can only READ events, cannot write.</p>
                <div class="space-y-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Client Key</label>
                        <div class="flex">
                            <input type="text" readonly value="{{.ClientKey}}" 
                                class="flex-1 px-3 py-2 bg-gray-50 border border-gray-300 rounded-l-md text-sm font-mono">
                            <button onclick="navigator.clipboard.writeText(this.previousElementSibling.value)" 
                                class="px-3 py-2 bg-gray-100 border border-l-0 border-gray-300 rounded-r-md hover:bg-gray-200">
                                ðŸ“‹
                            </button>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <form method="POST" action="/rotate-client-key" class="inline">
                            <button type="submit" 
                                class="px-3 py-2 bg-green-600 text-white text-sm rounded-md hover:bg-green-700">
                                ðŸ”„ Rotate Client Key
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {{else}}
        <form method="POST" action="/generate-token">
            <button type="submit" 
                class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Generate API Keys
            </button>
        </form>
        {{end}}
    </div>

    <!-- Usage Example -->
    <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-lg font-semibold mb-4">Usage Example</h2>
        <pre class="bg-gray-900 text-gray-100 p-4 rounded-md overflow-x-auto text-sm">
<code>curl -X POST "https://{{.WebhookURL}}?path=daily/$(date +%Y-%m-%d).md" \
  -H "Content-Type: text/plain" \
  -d "## $(date +%H:%M)
- Your note content here"</code>
        </pre>
    </div>

    <!-- Recent Events -->
    <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-lg font-semibold mb-4">Recent Events</h2>
        {{if .Events}}
        <div class="space-y-3" id="events-container">
            {{range .Events}}
            <div class="border border-gray-200 rounded-md p-3" data-event-id="{{.ID}}">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-sm font-medium text-gray-900">{{.Path}}</span>
                    <div class="flex items-center space-x-2">
                        <span class="text-xs text-gray-500">{{.Timestamp.Format "2006-01-02 15:04:05"}}</span>
                        <button onclick="deleteEvent('{{.ID}}')"
                            class="text-red-600 hover:text-red-800 text-xs px-2 py-1 rounded border border-red-300 hover:bg-red-50"
                            title="Delete event">
                            Delete
                        </button>
                    </div>
                </div>
                <pre class="text-xs bg-gray-50 p-2 rounded overflow-x-auto">{{.Data}}</pre>
            </div>
            {{end}}
        </div>
        {{else}}
        <p class="text-gray-500">No events yet</p>
        {{end}}
    </div>
</div>
        </main>
    </div>

    <script>
    async function deleteEvent(eventId) {
        if (!confirm('Are you sure you want to delete this event? This cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/events/${eventId}`, {
                method: 'DELETE',
                credentials: 'same-origin'
            });

            if (response.ok) {
                // Remove the event element from the DOM
                const eventElement = document.querySelector(`[data-event-id="${eventId}"]`);
                if (eventElement) {
                    eventElement.style.opacity = '0';
                    eventElement.style.transition = 'opacity 0.3s';
                    setTimeout(() => {
                        eventElement.remove();

                        // Check if there are any events left
                        const container = document.getElementById('events-container');
                        if (container && container.children.length === 0) {
                            container.parentElement.innerHTML = '<p class="text-gray-500">No events yet</p>';
                        }
                    }, 300);
                }
            } else {
                const errorText = await response.text();
                alert(`Failed to delete event: ${errorText}`);
            }
        } catch (error) {
            alert(`Error deleting event: ${error.message}`);
        }
    }
    </script>
</body>
</html>